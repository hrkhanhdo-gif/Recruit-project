<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Quill.js CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <style>
        /* MENTION SUGGESTIONS */
        #mention-suggestions {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1060;
            /* Higher than modal */
            display: none;
            width: 250px;
        }

        .mention-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }

        .mention-item:hover {
            background-color: #f1f3f5;
        }

        .mention-item.active {
            background-color: #e9ecef;
        }
    </style>

    <?!= include('css'); ?>
    <script>
        window.onerror = function (message, source, lineno, colno, error) {
            alert('Global Error: ' + message + ' at line ' + lineno);
        };
        var hasDB = <?!= JSON.stringify(typeof isDbSetup !== 'undefined' ? isDbSetup : false) ?>;
    </script>
</head>

<body>

    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-box">
            <div class="mb-4">
                <i class="fas fa-user-circle fa-4x" style="color: var(--primary-color);"></i>
            </div>
            <h2>Đăng Nhập Hệ Thống</h2>
            <div class="mb-3 text-start">
                <label class="form-label">Tên đăng nhập</label>
                <input type="text" class="form-control" id="login-username" placeholder="admin">
            </div>
            <div class="mb-4 text-start">
                <label class="form-label">Mật khẩu</label>
                <input type="password" class="form-control" id="login-password" placeholder="******">
            </div>
            <button class="btn btn-primary-custom" onclick="handleLogin()">ĐĂNG NHẬP</button>
            <p class="mt-3 text-muted" id="login-message"></p>

            <!-- Loading Spinner for Login -->
            <div id="login-loader" class="spinner-border text-warning mt-3" role="status" style="display:none;">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <!-- MAIN APP (Hidden by default) -->
    <div id="app-container" style="display:none;">

        <!-- Sidebar -->
        <div class="sidebar shadow">
            <div class="brand bg-gradient-premium">
                <i class="fas fa-rocket me-2"></i> HR RECRUIT <span class="badge bg-white text-primary ms-1"
                    style="font-size: 0.5rem; vertical-align: middle;">V3.0</span>
            </div>
            <nav class="mt-3">
                <a href="javascript:void(0)" class="nav-link active" onclick="showSection('dashboard', this)">
                    <i class="fas fa-th-large"></i> Báo cáo Tổng quan
                    <span id="nav-eval-badge" class="badge rounded-pill bg-rose ms-1"
                        style="display:none; font-size: 0.65rem;">0</span>
                </a>
                <a href="javascript:void(0)" class="nav-link" onclick="showSection('candidates', this)">
                    <i class="fas fa-user-friends"></i> Ứng Viên
                </a>
                <a href="javascript:void(0)" class="nav-link" onclick="showSection('kanban', this)">
                    <i class="fas fa-layer-group"></i> Quy trình Kanban
                </a>
                <a href="javascript:void(0)" class="nav-link" onclick="showSection('recruitment-hub', this)"
                    id="nav-recruitment-hub">
                    <i class="fas fa-briefcase"></i> Tuyển dụng & Đánh giá
                </a>
                <a href="javascript:void(0)" class="nav-link" onclick="showSection('jobs', this)" id="nav-jobs">
                    <i class="fas fa-paper-plane"></i> Quản lý WEB
                </a>
                <div class="nav-divider my-2 border-bottom border-secondary opacity-25"></div>
                <a href="javascript:void(0)" class="nav-link" onclick="showSection('settings', this)" id="nav-settings">
                    <i class="fas fa-sliders-h"></i> Cài Đặt Hệ Thống
                </a>
                <a href="javascript:void(0)" class="nav-link"
                    onclick="switchSettingsTab('tab-cleanup', document.getElementById('nav-settings')); showSection('settings', document.getElementById('nav-settings'))">
                    <i class="fas fa-tools text-warning"></i> Bảo Trì Hệ Thống
                </a>
                <a href="javascript:void(0)" class="nav-link" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Đăng Xuất
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">

            <!-- Top Bar -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 id="page-title" class="fw-bold">Tổng Quan</h3>
                <div class="d-flex align-items-center">
                    <span class="me-3 fw-bold"><i class="fas fa-user"></i> Xin chào, <span
                            id="current-user-display">Admin</span></span>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-warning position-relative" id="btn-notifications"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-bell"></i>
                            <span
                                class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                                id="notification-badge" style="display: none;">
                                0
                                <span class="visually-hidden">unread messages</span>
                            </span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow p-0" aria-labelledby="btn-notifications"
                            style="width: 350px; max-height: 400px; overflow-y: auto;">
                            <li class="p-2 border-bottom d-flex justify-content-between align-items-center bg-light">
                                <span class="fw-bold">Thông báo</span>
                                <small class="text-primary" style="cursor: pointer;"
                                    onclick="markAllNotificationsRead()">Đánh dấu đã đọc</small>
                            </li>
                            <div id="notification-list">
                                <li class="text-center p-3 text-muted">Không có thông báo mới</li>
                            </div>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- SECTIONS -->

            <!-- 1. DASHBOARD (Báo cáo Tuyển dụng) -->
            <div id="dashboard" class="section active">
                <div class="row mb-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">Dự án</label>
                        <select id="report-filter-project" class="form-select shadow-sm"
                            onchange="updateDashboardStats()">
                            <option value="">-- Tất cả Dự án --</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">Từ ngày</label>
                        <input type="date" id="report-filter-from" class="form-control shadow-sm"
                            onchange="updateDashboardStats()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">Đến ngày</label>
                        <input type="date" id="report-filter-to" class="form-control shadow-sm"
                            onchange="updateDashboardStats()">
                    </div>
                    <div class="col-md-3 text-end">
                        <button class="btn btn-primary shadow-sm" onclick="loadDashboardData()"><i
                                class="fas fa-sync-alt"></i> Tải lại</button>
                    </div>
                </div>

                <div class="alert alert-info py-2 shadow-sm d-flex align-items-center">
                    <i class="fas fa-info-circle me-2"></i>
                    <span class="fw-bold">Báo cáo Tuyển dụng</span>
                </div>

                <!-- Stat Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stat-card bg-gradient-blue p-3">
                            <h5>Tổng Ứng Viên</h5>
                            <h2 class="fw-bold" id="stat-total-candidates">0</h2>
                            <small><i class="fas fa-arrow-up"></i> +5 tuần này</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card bg-gradient-green p-3">
                            <h5>Đã Tuyển</h5>
                            <h2 class="fw-bold" id="stat-hired">0</h2>
                            <small>Trong tháng này</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card bg-gradient-orange p-3">
                            <h5>Đang Phỏng Vấn</h5>
                            <h2 class="fw-bold" id="stat-interviewing">0</h2>
                            <small>Cần xử lý gấp</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card bg-gradient-red p-3">
                            <h5>Đã Từ Chối</h5>
                            <h2 class="fw-bold" id="stat-rejected">0</h2>
                            <small>Tỷ lệ 52%</small>
                        </div>
                    </div>
                </div>

                <!-- Charts Area -->
                <div class="row">
                    <div class="col-md-8">
                        <div class="card border-0 shadow-sm p-3 mb-4">
                            <h5 class="card-title mb-3">Hiệu suất tuyển dụng theo tháng</h5>
                            <canvas id="recruitmentChart" height="150"></canvas>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm p-3 mb-4">
                            <h5 class="card-title mb-3">Nguồn ứng viên</h5>
                            <canvas id="sourceChart" height="300"></canvas>
                        </div>
                    </div>
                </div>

                <!-- ANALYTICS ROW -->
                <div class="row">
                    <div class="col-md-8">
                        <div class="card border-0 shadow-sm p-3 mb-4">
                            <h5 class="card-title mb-3">Phễu Tuyển Dụng (Funnel)</h5>
                            <canvas id="funnelChart" height="150"></canvas>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm p-3 mb-4 bg-primary text-white text-center">
                            <h5 class="card-title mb-0">Thời Gian Tuyển Dụng TB</h5>
                            <h2 class="fw-bold display-4 my-3" id="stat-time-to-hire">0</h2>
                            <p class="mb-0">ngày / ứng viên</p>
                        </div>
                        <div class="card border-0 shadow-sm p-3 mb-4">
                            <h5 class="card-title mb-3">Tỷ Lệ Chuyển Đổi</h5>
                            <h2 class="fw-bold text-success text-center" id="stat-conversion-rate">0%</h2>
                            <p class="text-muted text-center mb-0">Apply -> Hired</p>
                        </div>
                    </div>
                </div>

                <!-- ADVANCED ANALYTICS (NEW) -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm p-3 mb-4">
                            <h5 class="card-title mb-3"><i class="fas fa-chart-pie me-2 text-danger"></i>Phân tích lý do
                                từ chối</h5>
                            <canvas id="rejectionAnalysisChart" height="250"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm p-3 mb-4">
                            <h5 class="card-title mb-3"><i class="fas fa-stopwatch me-2 text-primary"></i>Time to Hire
                                theo phòng ban (ngày)</h5>
                            <canvas id="timeToHireChart" height="250"></canvas>
                        </div>
                    </div>
                </div>


                <!-- RECENT ACTIVITY (Moved inside Dashboard) -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm p-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title fw-bold"><i class="fas fa-history"></i> Hoạt động gần đây</h5>
                                <button class="btn btn-sm btn-outline-secondary" onclick="loadActivityLogs()"><i
                                        class="fas fa-sync-alt"></i></button>
                            </div>
                            <div id="activity-log-container" style="max-height: 400px; overflow-y: auto;">
                                <div class="text-center text-muted py-3">Đang tải...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Removed premature closing div of main-content -->

            <!-- 2. KANBAN BOARD -->
            <div id="kanban" class="section">
                <!-- NEW TECH HEADER -->
                <div class="kanban-tech-header">
                    <div class="d-flex align-items-center">
                        <div class="tech-icon-container">
                            <i class="fas fa-microchip tech-icon-glow"></i>
                        </div>
                        <div>
                            <h2 class="tech-title">QUY TRÌNH TUYỂN DỤNG</h2>
                            <div class="tech-subtitle"><span class="blink-status"></span>System Status: Operational
                            </div>
                        </div>
                    </div>
                    <div class="d-flex gap-3">
                        <div class="tech-stat-box">
                            <span class="tech-stat-label">TỔNG ỨNG VIÊN</span>
                            <span class="tech-stat-value" id="kanban-total-count">0</span>
                        </div>
                        <div class="tech-stat-box">
                            <span class="tech-stat-label">GIAI ĐOẠN HOẠT ĐỘNG</span>
                            <span class="tech-stat-value" id="kanban-stage-count">0</span>
                        </div>
                    </div>
                </div>

                <div class="d-flex flex-wrap gap-2 align-items-end mb-4 bg-white p-3 rounded shadow-sm">
                    <div class="flex-grow-1 d-flex flex-wrap gap-2">
                        <div style="min-width: 150px;">
                            <label class="form-label small fw-bold mb-1">Dự án</label>
                            <select id="kanban-filter-project" class="form-select form-select-sm"
                                onchange="updateTicketFilter('kanban-filter-project', 'kanban-filter-ticket'); renderKanbanBoard();">
                                <option value="">-- Tất cả Dự án --</option>
                            </select>
                        </div>
                        <div style="min-width: 150px;">
                            <label class="form-label small fw-bold mb-1">Ticket</label>
                            <select id="kanban-filter-ticket" class="form-select form-select-sm"
                                onchange="renderKanbanBoard()">
                                <option value="">-- Tất cả Ticket --</option>
                            </select>
                        </div>
                        <div style="min-width: 150px;">
                            <label class="form-label small fw-bold mb-1">Phòng ban</label>
                            <select id="kanban-filter-dept" class="form-select form-select-sm"
                                onchange="renderKanbanBoard()">
                                <option value="">-- Tất cả PB --</option>
                            </select>
                        </div>
                        <div style="min-width: 150px;">
                            <label class="form-label small fw-bold mb-1">Vị trí</label>
                            <select id="kanban-filter-pos" class="form-select form-select-sm"
                                onchange="renderKanbanBoard()">
                                <option value="">-- Tất cả Vị trí --</option>
                            </select>
                        </div>
                        <div style="min-width: 180px;">
                            <label class="form-label small fw-bold mb-1">Tìm kiếm</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-white border-end-0"><i
                                        class="fas fa-search text-muted"></i></span>
                                <input type="text" id="kanban-search" class="form-control border-start-0"
                                    placeholder="Tên, ID..." onkeyup="renderKanbanBoard()">
                            </div>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-primary btn-add-candidate" onclick="openCandidateDetail()">
                            <i class="fas fa-plus me-1"></i> Ứng Viên
                        </button>
                        <button class="btn btn-sm btn-outline-primary btn-add-candidate" data-bs-toggle="modal"
                            data-bs-target="#bulkUploadModal">
                            <i class="fas fa-file-import me-1"></i> Import
                        </button>
                    </div>
                </div>

                <div class="kanban-board" id="kanban-container">
                    <!-- Loading spinner (controlled by JS) -->
                    <div class="text-center py-5" id="kanban-loading" style="display: none;">
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-muted fw-bold">Đang tải dữ liệu...</p>
                    </div>
                </div>
            </div>

            <!-- 3. CANDIDATES LIST -->
            <div id="candidates" class="section">
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-2">
                                <label class="form-label small fw-bold">Dự án</label>
                                <select id="filter-candidate-project" class="form-select form-select-sm"
                                    onchange="updateTicketFilter('filter-candidate-project', 'filter-candidate-ticket'); renderCandidatesTable();">
                                    <option value="">-- Tất cả Dự án --</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small fw-bold">Ticket</label>
                                <select id="filter-candidate-ticket" class="form-select form-select-sm"
                                    onchange="renderCandidatesTable()">
                                    <option value="">-- Tất cả Ticket --</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small fw-bold">Phòng ban</label>
                                <select id="filter-candidate-dept" class="form-select form-select-sm"
                                    onchange="renderCandidatesTable()">
                                    <option value="">-- Tất cả PB --</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small fw-bold">Vị trí</label>
                                <select id="filter-candidate-pos" class="form-select form-select-sm"
                                    onchange="renderCandidatesTable()">
                                    <option value="">-- Tất cả Vị trí --</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small fw-bold">Giai đoạn</label>
                                <select id="filter-candidate-stage" class="form-select form-select-sm"
                                    onchange="renderCandidatesTable()">
                                    <option value="">-- Tất cả GĐ --</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small fw-bold">Trạng thái</label>
                                <select id="filter-candidate-status" class="form-select form-select-sm"
                                    onchange="renderCandidatesTable()">
                                    <option value="">-- Tất cả TT --</option>
                                </select>
                            </div>
                            <div class="col-md-2 mt-2">
                                <label class="form-label small fw-bold">Từ ngày</label>
                                <input type="date" id="filter-candidate-date-from" class="form-control form-control-sm"
                                    onchange="renderCandidatesTable()">
                            </div>
                            <div class="col-md-2 mt-2">
                                <label class="form-label small fw-bold">Đến ngày</label>
                                <input type="date" id="filter-candidate-date-to" class="form-control form-control-sm"
                                    onchange="renderCandidatesTable()">
                            </div>
                            <div class="col-md-4 mt-2">
                                <label class="form-label small fw-bold">Tìm kiếm</label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-white"><i
                                            class="fas fa-search text-muted"></i></span>
                                    <input type="text" id="candidates-search" class="form-control border-start-0"
                                        placeholder="Tìm theo tên, email, SĐT..." onkeyup="renderCandidatesTable()">
                                </div>
                            </div>
                            <div class="col-md-4 mt-2 text-end">
                                <button class="btn btn-sm btn-outline-secondary" onclick="resetCandidateFilters()"><i
                                        class="fas fa-undo me-1"></i> Reset</button>
                                <button class="btn btn-sm btn-success ms-2" onclick="exportCandidates()"><i
                                        class="fas fa-file-excel me-1"></i> Xuất Excel</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">Danh sách ứng viên (<span id="candidate-count-display">0</span>)
                            </h5>
                            <button class="btn btn-sm btn-primary btn-add-candidate" onclick="openCandidateDetail()">
                                <i class="fas fa-plus me-1"></i> Thêm mới
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover" id="candidates-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Họ Tên</th>
                                        <th>Vị trí</th>
                                        <th>Ngày ứng tuyển</th>
                                        <th>Trạng thái</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data rows go here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. WEB MANAGEMENT (Quản lý WEB) -->
            <div id="jobs" class="section">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-bottom-0 pb-0 pt-3">
                        <ul class="nav nav-tabs card-header-tabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active fw-bold" data-bs-toggle="tab" href="#web-jobs">
                                    <i class="fas fa-briefcase me-2"></i>Tin tuyển dụng
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link fw-bold" data-bs-toggle="tab" href="#web-news">
                                    <i class="fas fa-newspaper me-2"></i>Tin tức (News)
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="tab-content">
                    <!-- JOBS TAB -->
                    <div class="tab-pane fade show active" id="web-jobs">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4 class="fw-bold mb-0">Quản lý Tin Tuyển Dụng</h4>
                            <div>
                                <button class="btn btn-outline-danger me-2" onclick="debugUserInfo()">
                                    <i class="fas fa-bug"></i> Debug User
                                </button>
                                <button class="btn btn-primary-custom" data-bs-toggle="modal"
                                    data-bs-target="#addJobModal">
                                    <i class="fas fa-plus"></i> Tạo Tin Mới
                                </button>
                            </div>
                        </div>
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle" id="jobs-table">
                                        <thead class="table-light">
                                            <tr>
                                                <th>ID</th>
                                                <th>Vị trí</th>
                                                <th>Phòng ban</th>
                                                <th>Địa điểm</th>
                                                <th>Ngày tạo</th>
                                                <th>Trạng thái</th>
                                                <th>Hành động</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- NEWS TAB (Moved from Settings) -->
                    <div class="tab-pane fade" id="web-news">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4 class="fw-bold mb-0">Quản lý Tin Tức & Sự kiện</h4>
                            <button class="btn btn-primary" onclick="openNewsModal()">
                                <i class="fas fa-plus"></i> Viết Bài Mới
                            </button>
                        </div>
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle" id="news-table">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 50px;">ID</th>
                                                <th style="width: 60px;">Img</th>
                                                <th>Tiêu đề</th>
                                                <th>Ngày đăng</th>
                                                <th>Trạng thái</th>
                                                <th class="text-center" style="width: 150px;">Hành động</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RECRUITMENT HUB (Merged Projects & Tickets) -->
            <div id="recruitment-hub" class="section">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-bottom-0 pb-0 pt-3">
                        <ul class="nav nav-tabs card-header-tabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active fw-bold" data-bs-toggle="tab" href="#hub-projects">
                                    <i class="fas fa-project-diagram me-2"></i>Dự án Tuyển dụng
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link fw-bold" data-bs-toggle="tab" href="#hub-tickets">
                                    <i class="fas fa-ticket-alt me-2"></i>Phiếu yêu cầu (Tickets)
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link fw-bold" data-bs-toggle="tab" href="#hub-evaluations">
                                    <i class="fas fa-clipboard-check me-2"></i>Đánh giá Phỏng vấn
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="tab-content">
                    <!-- PROJECTS TAB -->
                    <div class="tab-pane fade show active" id="hub-projects">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h4 class="fw-bold mb-0">Danh sách Dự án</h4>
                                <small class="text-muted">Quản lý chiến dịch và quy trình tuyển dụng</small>
                            </div>
                            <div>
                                <button class="btn btn-primary" onclick="openProjectModal()">
                                    <i class="fas fa-plus"></i> Tạo Dự án Mới
                                </button>
                                <button class="btn btn-outline-secondary" onclick="loadProjects()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle mb-0" id="projects-table">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="ps-3">Mã Dự án</th>
                                                <th>Tên Dự án</th>
                                                <th>Đã tuyển / Số lượng</th>
                                                <th>Chi phí / Ngân sách</th>
                                                <th>Quản lý</th>
                                                <th>Ngày bắt đầu</th>
                                                <th>Ngày kết thúc</th>
                                                <th>Trạng thái</th>
                                                <th class="pe-3 text-center">Thao tác</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TICKETS TAB -->
                    <div class="tab-pane fade" id="hub-tickets">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h4 class="fw-bold mb-0">Phiếu yêu cầu tuyển dụng</h4>
                                <small class="text-muted">Theo dõi yêu cầu nhân sự từ các phòng ban</small>
                            </div>
                            <div>
                                <button class="btn btn-success" onclick="openTicketModal()">
                                    <i class="fas fa-plus-circle"></i> Tạo Yêu cầu Mới
                                </button>
                                <button class="btn btn-outline-secondary" onclick="loadTickets()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle mb-0" id="tickets-table">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="ps-3">Mã Ticket</th>
                                                <th>Vị trí</th>
                                                <th class="text-center">Đã tuyển / Số lượng</th>
                                                <th>Chi phí</th>
                                                <th>Dự án</th>
                                                <th>Ngày bắt đầu</th>
                                                <th>Deadline</th>
                                                <th>Trạng thái</th>
                                                <th class="pe-3">Thao tác</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- EVALUATIONS TAB (Moved from standalone section) -->
                    <div class="tab-pane fade" id="hub-evaluations">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h4 class="fw-bold mb-0">Quản lý Đánh giá Phỏng vấn</h4>
                                <small class="text-muted">Theo dõi và thực hiện đánh giá ứng viên</small>
                            </div>
                            <div>
                                <button class="btn btn-outline-danger me-2"
                                    onclick="google.script.run.withSuccessHandler(res => Swal.fire({title: 'DEBUG', html: '<pre style=\'text-align:left;font-size:10px\'>' + res + '</pre>', width: '800px'})).debugSheetData()">
                                    <i class="fas fa-bug"></i>
                                </button>
                                <button class="btn btn-primary" type="button" onclick="openCreateEvaluationModal()">
                                    <i class="fas fa-plus-circle"></i> Tạo Phiếu Đánh giá
                                </button>
                                <button class="btn btn-outline-secondary" type="button" onclick="loadEvaluations()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm ms-2" type="button"
                                    onclick="confirmResetEvaluationSheet()"
                                    title="Xóa và tạo lại bảng (Dành cho sửa lỗi cấu hình)">
                                    <i class="fas fa-redo"></i> Reset Sheet
                                </button>
                            </div>
                        </div>
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle mb-0" id="evaluations-table">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="ps-3">ID</th>
                                                <th>Ứng viên</th>
                                                <th>Vị trí</th>
                                                <th>Người đánh giá</th>
                                                <th>Trạng thái</th>
                                                <th>Kết quả</th>
                                                <th>Ngày tạo</th>
                                                <th class="pe-3">Thao tác</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SETTINGS SECTION -->
            <div id="settings" class="section">
                <div class="card border-0 shadow-sm overflow-hidden">
                    <div class="card-body p-0">
                        <div class="d-flex flex-column flex-md-row">
                            <!-- Settings Sidebar -->
                            <div class="settings-sidebar bg-light border-end" style="min-width: 260px;">
                                <div class="p-3 border-bottom bg-white d-flex align-items-center">
                                    <h6 class="mb-0 fw-bold"><i class="fas fa-sliders-h me-2 text-primary"></i>Danh mục
                                        cài đặt</h6>
                                </div>
                                <div class="p-3">
                                    <h6 class="text-uppercase text-muted smaller fw-bold mb-2 mt-2"
                                        style="font-size: 0.7rem;">Tổ chức</h6>
                                    <ul class="nav nav-pills flex-column gap-1 mb-4" role="tablist">
                                        <li class="nav-item">
                                            <a class="nav-link active d-flex align-items-center py-2 px-3"
                                                onclick="switchSettingsTab('tab-departments', this)">
                                                <i class="fas fa-sitemap me-2 text-primary"></i>Phòng ban & Vị trí
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link d-flex align-items-center py-2 px-3"
                                                onclick="switchSettingsTab('tab-recruiters', this)">
                                                <i class="fas fa-user-tie me-2 text-info"></i>Chuyên viên Tuyển dụng
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link d-flex align-items-center py-2 px-3"
                                                onclick="switchSettingsTab('tab-company', this)">
                                                <i class="fas fa-building me-2 text-secondary"></i>Thông tin công ty
                                            </a>
                                        </li>
                                    </ul>

                                    <h6 class="text-uppercase text-muted smaller fw-bold mb-2"
                                        style="font-size: 0.7rem;">Tiện ích</h6>
                                    <ul class="nav nav-pills flex-column gap-1 mb-4" role="tablist">
                                        <li class="nav-item">
                                            <a class="nav-link d-flex align-items-center py-2 px-3"
                                                onclick="switchSettingsTab('tab-sources', this)">
                                                <i class="fas fa-share-alt me-2 text-success"></i>Nguồn ứng viên
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link d-flex align-items-center py-2 px-3"
                                                onclick="switchSettingsTab('tab-rejection', this)">
                                                <i class="fas fa-user-slash me-2 text-danger"></i>Lý do từ chối
                                            </a>
                                        </li>
                                    </ul>

                                    <h6 class="text-uppercase text-muted smaller fw-bold mb-2"
                                        style="font-size: 0.7rem;">Hệ thống</h6>
                                    <ul class="nav nav-pills flex-column gap-1 mb-4" role="tablist">
                                        <li class="nav-item">
                                            <a class="nav-link d-flex align-items-center py-2 px-3"
                                                onclick="switchSettingsTab('tab-users', this)">
                                                <i class="fas fa-users me-2 text-primary"></i>Quản lý tài khoản
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link d-flex align-items-center py-2 px-3"
                                                onclick="switchSettingsTab('tab-email', this)">
                                                <i class="fas fa-envelope-open-text me-2 text-info"></i>Cấu hình Email
                                            </a>
                                        </li>
                                    </ul>

                                    <h6 class="text-uppercase text-muted smaller fw-bold mb-2"
                                        style="font-size: 0.7rem;">Bảo trì & Hệ thống</h6>
                                    <ul class="nav nav-pills flex-column gap-1" role="tablist">
                                        <li class="nav-item">
                                            <a class="nav-link d-flex align-items-center py-2 px-3"
                                                onclick="switchSettingsTab('tab-cleanup', this)">
                                                <i class="fas fa-tools me-2 text-primary"></i>Quản trị hệ thống
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <!-- Settings Content Area -->
                            <div class="flex-grow-1 p-0 bg-transparent" style="min-height: 500px;">
                                <div class="tab-content h-100">
                                    <!-- RECRUITERS TAB -->
                                    <div class="tab-pane fade section-card bg-white p-4 shadow-sm rounded-3"
                                        id="tab-recruiters">
                                        <div class="d-flex justify-content-between align-items-center mb-4">
                                            <h5 class="mb-0 fw-bold text-primary"><i
                                                    class="fas fa-user-tie me-2"></i>Chuyên viên Tuyển dụng</h5>
                                            <button class="btn btn-primary btn-sm rounded-pill px-3"
                                                onclick="openRecruiterModal()">
                                                <i class="fas fa-plus me-1"></i> Thêm mới
                                            </button>
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-hover align-middle settings-content-table"
                                                id="recruiters-table">
                                                <thead>
                                                    <tr>
                                                        <th>Họ tên</th>
                                                        <th>Email</th>
                                                        <th>SĐT</th>
                                                        <th>Chức vụ</th>
                                                        <th>Vai trò</th>
                                                        <th class="text-end">Hành động</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- DEPARTMENTS TAB -->
                                    <div class="tab-pane fade show active section-card bg-white p-4 shadow-sm rounded-3"
                                        id="tab-departments">
                                        <div class="d-flex justify-content-between mb-3">
                                            <h5>Quản lý Phòng ban & Vị trí công việc</h5>
                                            <button class="btn btn-sm btn-primary" onclick="promptAddDepartment()">
                                                <i class="fas fa-plus"></i> Thêm Phòng ban
                                            </button>
                                        </div>
                                        <div id="departments-container" class="row g-3">
                                            <!-- Department cards will be injected here -->
                                        </div>
                                    </div>

                                    <!-- USERS TAB -->
                                    <div class="tab-pane fade section-card bg-white p-4 shadow-sm rounded-3"
                                        id="tab-users">
                                        <div class="d-flex justify-content-between align-items-center mb-4">
                                            <h5 class="mb-0 fw-bold text-primary"><i
                                                    class="fas fa-users-cog me-2"></i>Quản lý tài khoản</h5>
                                            <button class="btn btn-primary btn-sm rounded-pill px-3"
                                                onclick="openUserModal()">
                                                <i class="fas fa-plus me-1"></i> Thêm User
                                            </button>
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-hover align-middle settings-content-table"
                                                id="users-table">
                                                <thead>
                                                    <tr>
                                                        <th>Username</th>
                                                        <th>Họ tên</th>
                                                        <th>Email</th>
                                                        <th>SĐT</th>
                                                        <th>Vai trò</th>
                                                        <th>Phòng ban</th>
                                                        <th class="text-end">Hành động</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>



                                    <!-- EMAIL TAB -->
                                    <div class="tab-pane fade section-card bg-white p-4 shadow-sm rounded-3"
                                        id="tab-email">
                                        <div class="d-flex justify-content-between align-items-center mb-4">
                                            <h5 class="mb-0 fw-bold text-primary"><i
                                                    class="fas fa-envelope-open-text me-2"></i>Mẫu Email Hệ thống</h5>
                                            <button class="btn btn-primary btn-sm rounded-pill px-3"
                                                onclick="promptAddEmailTemplate()">
                                                <i class="fas fa-plus me-1"></i> Thêm mẫu mới
                                            </button>
                                        </div>

                                        <div class="row g-4">
                                            <!-- Template List (Left) -->
                                            <div class="col-md-4">
                                                <div class="list-group list-group-flush border rounded shadow-sm"
                                                    id="email-template-list"
                                                    style="max-height: 500px; overflow-y: auto;">
                                                    <div class="text-center p-3 text-muted">Đang tải danh sách...</div>
                                                </div>
                                            </div>

                                            <!-- Editor (Right) -->
                                            <div class="col-md-8">
                                                <div class="card border shadow-sm h-100" id="email-editor-container"
                                                    style="display: none;">
                                                    <div class="card-header bg-light border-bottom">
                                                        <h6 id="template-editor-title"
                                                            class="mb-0 fw-bold text-primary">Chỉnh sửa mẫu</h6>
                                                    </div>
                                                    <div class="card-body" id="email-template-form">
                                                        <div class="mb-3">
                                                            <label class="form-label small fw-bold">Tên mẫu</label>
                                                            <input type="text" id="tpl-name" class="form-control">
                                                            <input type="hidden" id="tpl-id">
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label small fw-bold">Tiêu đề
                                                                (Subject)</label>
                                                            <input type="text" id="tpl-subject" class="form-control"
                                                                placeholder="Sử dụng {{Name}}, {{Position}}">
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label small fw-bold">Nội dung (HTML
                                                                Body)</label>
                                                            <textarea id="tpl-body" class="form-control"
                                                                style="height: 300px;"></textarea>
                                                        </div>
                                                        <div class="d-flex justify-content-between">
                                                            <button class="btn btn-danger btn-sm"
                                                                onclick="deleteCurrentTemplate()">
                                                                <i class="fas fa-trash me-1"></i> Xóa mẫu
                                                            </button>
                                                            <button class="btn btn-primary px-4"
                                                                onclick="saveEmailTemplate()">
                                                                <i class="fas fa-save me-2"></i>Lưu mẫu
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div id="email-editor-placeholder"
                                                    class="h-100 d-flex align-items-center justify-content-center border rounded bg-light p-5">
                                                    <div class="text-center text-muted">
                                                        <i class="fas fa-mouse-pointer fa-3x mb-3 opacity-25"></i>
                                                        <p>Chọn một mẫu bên trái để chỉnh sửa</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- COMPANY INFO TAB -->
                                    <div class="tab-pane fade section-card bg-white p-4 shadow-sm rounded-3"
                                        id="tab-company">
                                        <div class="d-flex justify-content-between align-items-center mb-4">
                                            <h5 class="mb-0 fw-bold text-primary"><i
                                                    class="fas fa-building me-2"></i>Thông tin Công ty</h5>
                                            <button class="btn btn-primary btn-sm rounded-pill px-3"
                                                onclick="saveCompanyInfo()">
                                                <i class="fas fa-save me-1"></i> Lưu thông tin
                                            </button>
                                        </div>
                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <label class="form-label fw-bold small">Tên công ty</label>
                                                <input type="text" class="form-control" id="comp-name"
                                                    placeholder="Ví dụ: Công ty TNHH ABC">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label fw-bold small">Mã số thuế</label>
                                                <input type="text" class="form-control" id="comp-taxcode"
                                                    placeholder="0101234567">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label fw-bold small">Email công ty</label>
                                                <input type="email" class="form-control" id="comp-email"
                                                    placeholder="hr@abc.com">
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label fw-bold small">Số điện thoại</label>
                                                <input type="text" class="form-control" id="comp-phone"
                                                    placeholder="024 1234 5678">
                                            </div>
                                            <div class="col-md-6">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <label class="form-label fw-bold small mb-0">Địa chỉ</label>
                                                    <button class="btn btn-xs btn-outline-success"
                                                        onclick="addCompanyAddress()">
                                                        <i class="fas fa-plus"></i>
                                                    </button>
                                                </div>
                                                <div id="comp-addresses-container" class="vstack gap-2"></div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <label class="form-label fw-bold small mb-0">Người đại diện / Người
                                                        ký</label>
                                                    <button class="btn btn-xs btn-outline-success"
                                                        onclick="addCompanySigner()">
                                                        <i class="fas fa-plus"></i>
                                                    </button>
                                                </div>
                                                <div id="comp-signers-container" class="vstack gap-2"></div>
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label fw-bold small">Thời gian làm việc</label>
                                                <textarea class="form-control" id="comp-worktime" rows="2"
                                                    placeholder="Ví dụ: Thứ 2 - Thứ 6: 08:30 - 17:30"></textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- SOURCES TAB -->
                                    <div class="tab-pane fade section-card bg-white p-4 shadow-sm rounded-3"
                                        id="tab-sources">
                                        <div class="d-flex justify-content-between align-items-center mb-4">
                                            <h5 class="mb-0 fw-bold text-primary"><i
                                                    class="fas fa-external-link-alt me-2"></i>Nguồn ứng viên</h5>
                                            <button class="btn btn-primary btn-sm rounded-pill px-3"
                                                onclick="promptAddCandidateSource()">
                                                <i class="fas fa-plus me-1"></i> Thêm nguồn
                                            </button>
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-hover align-middle settings-content-table"
                                                id="sources-table">
                                                <thead>
                                                    <tr>
                                                        <th>Tên nguồn</th>
                                                        <th class="text-end">Hành động</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- REJECTION REASONS TAB -->
                                    <div class="tab-pane fade section-card bg-white p-4 shadow-sm rounded-3"
                                        id="tab-rejection">
                                        <div class="d-flex justify-content-between align-items-center mb-4">
                                            <h5 class="mb-0 fw-bold text-primary"><i
                                                    class="fas fa-user-slash me-2"></i>Lý do từ chối</h5>
                                            <button class="btn btn-primary btn-sm rounded-pill px-3"
                                                onclick="saveRejectionReasons()">
                                                <i class="fas fa-save me-1"></i> Lưu cấu hình
                                            </button>
                                        </div>
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <div class="card border border-primary-subtle shadow-none">
                                                    <div
                                                        class="card-header bg-primary-subtle d-flex justify-content-between align-items-center">
                                                        <span class="fw-bold text-primary small">Công ty từ chối ứng
                                                            viên</span>
                                                        <button class="btn btn-xs btn-primary"
                                                            onclick="addRejectionReasonRow('Company')">
                                                            <i class="fas fa-plus"></i>
                                                        </button>
                                                    </div>
                                                    <div class="card-body p-2">
                                                        <div id="rejection-company-list" class="vstack gap-2"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card border border-warning-subtle shadow-none">
                                                    <div
                                                        class="card-header bg-warning-subtle d-flex justify-content-between align-items-center">
                                                        <span class="fw-bold text-warning-emphasis small">Ứng viên từ
                                                            chối</span>
                                                        <button class="btn btn-xs btn-warning"
                                                            onclick="addRejectionReasonRow('Candidate')">
                                                            <i class="fas fa-plus"></i>
                                                        </button>
                                                    </div>
                                                    <div class="card-body p-2">
                                                        <div id="rejection-candidate-list" class="vstack gap-2"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- CLEANUP TAB -->
                                    <div class="tab-pane fade section-card bg-white p-4 shadow-sm rounded-3"
                                        id="tab-cleanup">
                                        <div class="mb-4 text-center">
                                            <div class="p-4 rounded-circle bg-danger-subtle d-inline-block mb-3">
                                                <i class="fas fa-broom text-danger display-4"></i>
                                            </div>
                                            <h4 class="fw-bold text-danger">Tối ưu & Dọn dẹp Database</h4>
                                            <p class="text-muted">Tăng tốc độ truy xuất bằng cách dọn dẹp dữ liệu rác.
                                            </p>
                                        </div>
                                        <div
                                            class="alert alert-warning shadow-none border-warning-subtle mb-4 text-start">
                                            <h6 class="fw-bold"><i class="fas fa-exclamation-triangle me-2"></i>Lưu ý
                                                quan trọng</h6>
                                            <p class="small mb-2">Công cụ này sẽ thực hiện các tác vụ sau:</p>
                                            <ul class="small mb-0">
                                                <li>Hợp nhất dữ liệu từ các cột trùng lặp.</li>
                                                <li>Chuyển đổi các ghi chú mới vào lịch sử ghi chú.</li>
                                                <li>Xóa bỏ các cột thừa để tối ưu hóa hiệu suất Sheet.</li>
                                            </ul>
                                        </div>
                                        <div class="d-grid">
                                            <button class="btn btn-danger py-3 fw-bold" onclick="runDatabaseCleanup()">
                                                <i class="fas fa-rocket me-2"></i>BẮT ĐẦU QUY TRÌNH DỌN DẸP
                                            </button>
                                        </div>
                                        <div id="cleanup-loader" class="mt-3" style="display:none;">
                                            <div class="spinner-border text-danger" role="status"></div>
                                            <p class="mt-2 text-muted">Đang xử lý dữ liệu, vui lòng đợi...</p>
                                        </div>
                                        <div class="text-center py-5">
                                            <div class="mb-4">
                                                <i class="fas fa-shield-alt fa-4x text-primary opacity-25"></i>
                                            </div>
                                            <h4 class="fw-bold mb-3">Quản trị & Bảo trì Hệ thống</h4>
                                            <p class="text-muted mb-5 mx-auto" style="max-width: 500px;">
                                                Thực hiện các tác vụ bảo trì định kỳ để đảm bảo hệ thống luôn hoạt động
                                                ổn định và an toàn.
                                            </p>

                                            <div class="d-flex flex-wrap justify-content-center gap-3">
                                                <button class="btn btn-primary btn-lg px-4 rounded-pill shadow-sm"
                                                    onclick="runSystemBackup()">
                                                    <i class="fas fa-cloud-download-alt me-2"></i>Sao lưu Toàn bộ Dữ
                                                    liệu
                                                </button>

                                                <button class="btn btn-success btn-lg px-4 rounded-pill shadow-sm"
                                                    onclick="runSheetMigration()">
                                                    <i class="fas fa-layer-group me-2"></i>Hợp nhất & Tối ưu Sheet
                                                </button>

                                                <button
                                                    class="btn btn-outline-danger btn-lg px-4 rounded-pill shadow-sm"
                                                    onclick="runDatabaseCleanup()">
                                                    <i class="fas fa-broom me-2"></i>Dọn dẹp Activity Log
                                                </button>

                                                <button class="btn btn-danger btn-lg px-4 rounded-pill shadow-sm"
                                                    onclick="runResetDatabase()">
                                                    <i class="fas fa-trash-alt me-2"></i>Reset & Tái cấu trúc Database
                                                </button>
                                            </div>

                                            <div class="mt-5 p-3 bg-light rounded-3 border border-warning-subtle"
                                                style="max-width: 600px; margin: 0 auto;">
                                                <p class="small text-warning mb-0">
                                                    <i class="fas fa-exclamation-triangle me-2"></i><strong>Lưu ý quan
                                                        trọng:</strong>
                                                    Việc hợp nhất Sheet sẽ thay đổi cấu trúc backend để ứng dụng mượt mà
                                                    hơn.
                                                    Vui lòng bấm <strong>Sao lưu dữ liệu</strong> trước khi thực hiện để
                                                    đảm bảo an toàn 100%.
                                                </p>
                                            </div>

                                            <div id="backup-status" class="mt-4 small text-info" style="display:none;">
                                            </div>
                                        </div>
                                    </div>
                                </div> <!-- end tab-content -->
                            </div> <!-- end flex-grow-1 -->
                        </div> <!-- end d-flex row -->
                    </div> <!-- end card-body -->
                </div> <!-- end card -->
            </div> <!-- end settings section -->

            <!-- RECRUITER MODAL (Add/Edit) -->
            <div class="modal fade" id="recruiterModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="recruiterModalLabel">Chuyên viên Tuyển dụng</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="recruiter-form">
                                <input type="hidden" id="rec-id">
                                <input type="hidden" id="rec-joinDate">
                                <div class="mb-3">
                                    <label class="form-label">Họ và tên <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="rec-name" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Email <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control" id="rec-email" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Số điện thoại</label>
                                    <input type="text" class="form-control" id="rec-phone">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Chức vụ tại công ty</label>
                                    <input type="text" class="form-control" id="rec-position">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Vai trò</label>
                                    <select class="form-select" id="rec-role">
                                        <option value="Viewer">Viewer</option>
                                        <option value="User">User</option>
                                        <option value="Manager">Manager</option>
                                        <option value="Admin">Admin</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                            <button type="button" class="btn btn-primary" onclick="saveRecruiter()">Lưu thông
                                tin</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- MODAL: ADD JOB -->
        <div class="modal fade" id="addJobModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Tạo Tin Tuyển Dụng</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="add-job-form">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Tiêu đề</label>
                                    <input type="text" class="form-control" name="title" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Phòng ban</label>
                                    <select class="form-select" name="department">
                                        <option>IT</option>
                                        <option>HR</option>
                                        <option>Sales</option>
                                        <option>Marketing</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Địa điểm</label>
                                    <select class="form-select" name="location">
                                        <option>Hà Nội</option>
                                        <option>Hồ Chí Minh</option>
                                        <option>Remote</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Loại hình</label>
                                    <select class="form-select" name="type">
                                        <option>Full-time</option>
                                        <option>Part-time</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Mô tả</label>
                                    <textarea class="form-control" name="description" rows="3"></textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        <button type="button" class="btn btn-primary-custom" onclick="saveJob()">Lưu Tin</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL: VIEW JOB DETAILS (ADMIN) -->
        <div class="modal fade" id="viewJobModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title fw-bold" id="view-job-title">Chi Tiết Công Việc</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Phòng ban:</strong> <span id="view-job-dept"></span>
                            </div>
                            <div class="col-md-6">
                                <strong>Đia điểm:</strong> <span id="view-job-loc"></span>
                            </div>
                            <div class="col-md-6">
                                <strong>Loại hình:</strong> <span id="view-job-type"></span>
                            </div>
                            <div class="col-md-6">
                                <strong>Trạng thái:</strong> <span id="view-job-status"></span>
                            </div>
                            <div class="col-md-6">
                                <strong>Ngày tạo:</strong> <span id="view-job-date"></span>
                            </div>
                        </div>
                        <hr>
                        <div class="mb-3">
                            <h6 class="fw-bold">Mô tả công việc:</h6>
                            <div id="view-job-desc" class="p-3 bg-light rounded" style="white-space: pre-wrap;"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        <button type="button" class="btn btn-primary-custom" id="btn-edit-from-view">
                            <i class="fas fa-edit"></i> Chỉnh sửa
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL: ADD/EDIT USER -->
        <div class="modal fade" id="addUserModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="userModalLabel">Thêm Người Dùng</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="user-form">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Username <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="u-username" required>
                                    <input type="hidden" id="u-mode" value="add">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Password <span class="text-danger"
                                            id="u-password-req">*</span></label>
                                    <input type="password" class="form-control" id="u-password">
                                    <small class="text-muted" id="u-password-hint" style="display:none">Để trống nếu
                                        không
                                        đổi</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Họ tên <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="u-fullname" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="u-email">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Số điện thoại</label>
                                    <input type="text" class="form-control" id="u-phone">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Vai trò <span class="text-danger">*</span></label>
                                    <select class="form-select" id="u-role">
                                        <option value="User">User</option>
                                        <option value="Viewer">Viewer</option>
                                        <option value="Admin">Admin</option>
                                        <option value="Manager">Manager</option>
                                    </select>
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">Phòng ban</label>
                                    <select class="form-select" id="u-department">
                                        <option value="All">All</option>
                                    </select>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        <button type="button" class="btn btn-primary" onclick="saveUser()">Lưu User</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL: CANDIDATE DETAILS -->
        <div class="modal fade" id="candidateDetailModal" data-bs-backdrop="static" data-bs-keyboard="false"
            tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">Chi Tiết Ứng Viên</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="edit-candidate-form">
                            <input type="hidden" id="current-candidate-id">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Họ tên ứng viên <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="detail-name" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">Giới tính</label>
                                    <select class="form-select" id="detail-gender">
                                        <option value="">- Chọn -</option>
                                        <option>Nam</option>
                                        <option>Nữ</option>
                                        <option>Khác</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">Năm sinh</label>
                                    <input type="number" class="form-control" id="detail-dob" placeholder="YYYY">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Số điện thoại <span
                                            class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                        <input type="tel" class="form-control" id="detail-phone" required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Email <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                        <input type="email" class="form-control" id="detail-email" required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Phòng ban <span
                                            class="text-danger">*</span></label>
                                    <select class="form-select" id="detail-department"
                                        onchange="populatePositionDropdown()">
                                        <option value="">Chọn phòng ban</option>
                                        <!-- Options populated dynamically -->
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Vị trí ứng tuyển <span
                                            class="text-danger">*</span></label>
                                    <select class="form-select" id="detail-position">
                                        <option>Chọn vị trí</option>
                                        <option>Java Developer</option>
                                        <option>Python Developer</option>
                                        <option>Marketing Executive</option>
                                        <option>Sales Manager</option>
                                        <option>HR Manager</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Kinh nghiệm</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-briefcase"></i></span>
                                        <input type="text" class="form-control" id="detail-experience"
                                            placeholder="VD: 2 năm">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Tên trường</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-university"></i></span>
                                        <input type="text" class="form-control" id="detail-school"
                                            placeholder="VD: Đại học Kinh tế">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Trình độ học vấn</label>
                                    <select class="form-select" id="detail-education-level">
                                        <option value="">Chọn trình độ</option>
                                        <option>Dưới THPT</option>
                                        <option>THPT</option>
                                        <option>Trung cấp</option>
                                        <option>Cao Đẳng</option>
                                        <option>Đại học</option>
                                        <option>Sau đại học</option>
                                    </select>
                                </div>

                                <!-- NEW TRACKING FIELDS -->
                                <div class="col-md-4 hire-tracking-field" style="display:none;">
                                    <label class="form-label fw-bold text-success">Ngày nhận việc</label>
                                    <input type="date" class="form-control border-success" id="detail-hire-date"
                                        readonly>
                                </div>
                                <div class="col-md-4 rejection-tracking-field" style="display:none;">
                                    <label class="form-label fw-bold text-danger">Đối tượng từ chối</label>
                                    <select class="form-select border-danger" id="detail-rejection-source">
                                        <option value="">-- Chọn đối tượng --</option>
                                        <option value="Company">Công ty từ chối ứng viên</option>
                                        <option value="Candidate">Ứng viên từ chối Công ty</option>
                                    </select>
                                </div>
                                <div class="col-md-4 rejection-tracking-field" style="display:none;"
                                    id="rejection-type-container">
                                    <label class="form-label fw-bold text-danger">Loại từ chối</label>
                                    <select class="form-select border-danger" id="detail-rejection-type">
                                        <option value="">-- Chọn loại --</option>
                                    </select>
                                </div>
                                <div class="col-md-4 rejection-tracking-field" style="display:none;"
                                    id="rejection-reason-container">
                                    <label class="form-label fw-bold text-danger">Lý do chi tiết</label>
                                    <input type="text" class="form-control border-danger" id="detail-rejection-reason"
                                        placeholder="Mô tả cụ thể lý do...">
                                </div>
                                <!-- END TRACKING -->

                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Chuyên ngành</label>
                                    <input type="text" class="form-control" id="detail-major"
                                        placeholder="VD: Marketing">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Mức lương mong muốn</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-dollar-sign"></i></span>
                                        <input type="text" class="form-control" id="detail-salary"
                                            placeholder="VD: 15.000.000">
                                        <span class="input-group-text">VNĐ</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Nguồn ứng viên</label>
                                    <select class="form-select" id="detail-source">
                                        <option value="">Chọn nguồn (Đang tải...)</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Nhân viên tuyển dụng <span
                                            class="text-danger">*</span></label>
                                    <select class="form-select" id="detail-recruiter">
                                        <option>Chọn nhân viên</option>
                                        <option>Nguyễn Văn A</option>
                                        <option>Trần Thị B</option>
                                        <option>Lê Văn C</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Trạng thái <span
                                            class="text-danger">*</span></label>
                                    <select class="form-select" id="detail-status">
                                        <!-- Populated dynamically from workflow stages -->
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Thuộc Yêu cầu (Ticket)</label>
                                    <select class="form-select" id="detail-ticket-id">
                                        <option value="">-- Không có --</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Tình trạng liên hệ</label>
                                    <select class="form-select" id="detail-contact-status">
                                        <option>Mới tiếp nhận</option>
                                        <option>Đã liên lạc</option>
                                        <option>Đang trao đổi</option>
                                        <option>Chờ phản hồi</option>
                                        <option>Không nghe máy</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-bold">Link CV / Upload File</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="detail-cv-link"
                                            placeholder="Nhập link hoặc upload file">
                                        <button class="btn btn-outline-info" type="button" id="btn-view-cv-detail"
                                            title="Xem CV">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <input type="file" class="form-control" id="detail-cv-file"
                                            accept=".pdf,.doc,.docx,.jpg,.png">
                                        <button class="btn btn-outline-primary" type="button"
                                            onclick="document.getElementById('detail-cv-file').click()">
                                            <i class="fas fa-upload"></i> Upload
                                        </button>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-bold">Lịch sử Ghi chú</label>
                                    <div id="detail-notes-history" class="form-control bg-light"
                                        style="height: 150px; overflow-y: auto; white-space: pre-wrap; font-size: 0.9rem;">
                                    </div>
                                </div>
                                <div class="col-12 mt-2">
                                    <label class="form-label fw-bold">Thêm ghi chú mới</label>
                                    <textarea class="form-control" id="detail-new-note" rows="2"
                                        placeholder="Nhập ghi chú mới..."></textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer d-flex justify-content-between">
                        <div>
                            <button type="button" class="btn btn-outline-danger me-2"
                                onclick="generateCandidateProfilePDF()">
                                <i class="fas fa-file-pdf"></i> Xuất Hồ Sơ PDF
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="openDocumentHub()">
                                <i class="fas fa-file-invoice"></i> Tạo Văn Bản (Offer/HĐ)
                            </button>
                        </div>
                        <div>
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Đóng</button>
                            <!-- Allow Recruiter/Admin to Request Evaluation -->
                            <button type="button" class="btn btn-warning me-2" id="btn-request-eval"
                                onclick="openCreateEvaluationModal()" style="display:none;">
                                <i class="fas fa-clipboard-list"></i> Tạo Đánh giá PV
                            </button>
                            <button type="button" class="btn btn-primary" onclick="saveCandidateDetail()">Lưu</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL: DOCUMENT HUB (AUTO GENERATE PDF) -->
        <div class="modal fade" id="documentHubModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-dark text-white">
                        <h5 class="modal-title"><i class="fas fa-file-signature"></i> Trung tâm Tạo Văn bản</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Chọn loại văn bản cần tạo</label>
                            <select class="form-select" id="doc-template-select" onchange="toggleDocExtraFields()">
                                <option value="TemplateOffer">Thư mời nhận việc (Offer Letter)</option>
                                <option value="TemplateContractProbation">Hợp đồng thử việc (Probation)</option>
                                <option value="TemplateContractOfficial">Hợp đồng lao động (Official)</option>
                                <option value="TemplateCandidateProfile">Hồ sơ khảo sát (Profile Summary)</option>
                            </select>
                        </div>

                        <!-- Extra fields for documents -->
                        <div id="doc-extra-fields" class="card p-3 bg-light border-0">
                            <h6 class="fw-bold mb-3 border-bottom pb-2">Thông tin bổ sung</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Số văn bản (Ghi đè)</label>
                                    <input type="text" class="form-control" id="doc-number-override"
                                        placeholder="Ví dụ: 123/2024">
                                </div>
                                <div class="col-md-6" id="field-salary">
                                    <label class="form-label">Mức lương (VNĐ)</label>
                                    <input type="text" class="form-control" id="doc-salary"
                                        placeholder="Ví dụ: 15,000,000">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Lương bằng chữ (Đồng)</label>
                                    <input type="text" class="form-control" id="doc-salary-words"
                                        placeholder="Ví dụ: Mười lăm triệu">
                                </div>
                                <div class="col-md-6" id="field-start-date">
                                    <label class="form-label">Ngày bắt đầu</label>
                                    <input type="date" class="form-control" id="doc-start-date">
                                </div>
                                <div class="col-md-6" id="field-probation-end">
                                    <label class="form-label">Ngày kết thúc thử việc</label>
                                    <input type="date" class="form-control" id="doc-probation-end">
                                </div>
                                <div class="col-md-6" id="field-deadline">
                                    <label class="form-label">Hạn phản hồi</label>
                                    <input type="date" class="form-control" id="doc-deadline">
                                </div>
                                <div class="col-md-6" id="field-contract-period">
                                    <label class="form-label">Thời hạn hợp đồng</label>
                                    <input type="text" class="form-control" id="doc-contract-period"
                                        placeholder="Ví dụ: 12 tháng">
                                </div>
                                <div class="col-md-6" id="field-issuance-location">
                                    <label class="form-label">Địa điểm lập văn bản</label>
                                    <input type="text" class="form-control" id="doc-issuance-location"
                                        placeholder="Ví dụ: Hà Nội">
                                </div>
                                <div class="col-12" id="field-manager">
                                    <label class="form-label">Người báo cáo trực tiếp</label>
                                    <input type="text" class="form-control" id="doc-manager"
                                        placeholder="Tên và chức vụ">
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Địa điểm làm việc</label>
                                    <select class="form-select" id="doc-location-select">
                                        <option value="">-- Chọn địa điểm --</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Người ký / Đại diện</label>
                                    <select class="form-select" id="doc-signer-select">
                                        <option value="">-- Chọn người ký --</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div id="doc-loading" class="text-center mt-3" style="display:none;">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 text-muted">Đang xử lý PDF, vui lòng đợi...</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        <button type="button" class="btn btn-success" id="btn-generate-doc"
                            onclick="generateDocument()">
                            <i class="fas fa-magic"></i> Tạo & Xuất File PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL: SEND EMAIL (SMART GMAIL STYLE) -->
        <div class="modal fade" id="sendEmailModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content shadow-lg border-0">
                    <div class="modal-header bg-dark text-white py-2">
                        <h6 class="modal-title"><i class="fas fa-envelope me-2"></i>Thư mới</h6>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-0">
                        <form id="send-email-form">
                            <input type="hidden" id="email-candidate-id">

                            <!-- Recipients -->
                            <div class="border-bottom px-3 py-2">
                                <div class="d-flex align-items-center mb-1">
                                    <span class="text-muted me-2" style="width: 40px;">Đến</span>
                                    <input type="text" class="form-control border-0 p-0 shadow-none" id="email-to"
                                        readonly style="background: transparent;">
                                    <div class="ms-auto">
                                        <small class="text-primary cursor-pointer me-2"
                                            onclick="toggleEmailField('cc')">Cc</small>
                                        <small class="text-primary cursor-pointer"
                                            onclick="toggleEmailField('bcc')">Bcc</small>
                                    </div>
                                </div>

                                <div id="email-cc-container" style="display: none;"
                                    class="d-flex align-items-baseline mb-1">
                                    <span class="text-muted me-2" style="width: 40px;">Cc</span>
                                    <div class="recipient-tags-input flex-grow-1 border-0 p-0 shadow-none"
                                        id="email-cc-tags">
                                        <input type="text" class="border-0 shadow-none flex-grow-1" id="email-cc-input"
                                            placeholder="Thêm CC..." onkeydown="handleRecipientInput(event, 'cc')">
                                    </div>
                                </div>

                                <div id="email-bcc-container" style="display: none;"
                                    class="d-flex align-items-baseline mb-1">
                                    <span class="text-muted me-2" style="width: 40px;">Bcc</span>
                                    <div class="recipient-tags-input flex-grow-1 border-0 p-0 shadow-none"
                                        id="email-bcc-tags">
                                        <input type="text" class="border-0 shadow-none flex-grow-1" id="email-bcc-input"
                                            placeholder="Thêm BCC..." onkeydown="handleRecipientInput(event, 'bcc')">
                                    </div>
                                </div>
                            </div>

                            <!-- Template & Subject -->
                            <div class="border-bottom px-3 py-2 d-flex align-items-center">
                                <select class="form-select form-select-sm border-0 border-end shadow-none me-2"
                                    id="email-template-select" style="width: 150px; background: transparent;"
                                    onchange="loadTemplateContent(this.value)">
                                    <option value="">-- Mẫu --</option>
                                </select>
                                <input type="text" class="form-control border-0 p-0 shadow-none" id="email-subject"
                                    placeholder="Tiêu đề">
                            </div>

                            <!-- Rich Text Editor -->
                            <div class="email-editor-container border-0">
                                <div id="email-body-quill"></div>
                            </div>

                            <!-- Attachments Preview -->
                            <div id="email-attachments-list" class="px-3 py-2 border-top bg-light"
                                style="display: none;">
                                <!-- Badges will appear here -->
                            </div>
                        </form>
                    </div>
                    <!-- Bottom Toolbar -->
                    <div class="modal-footer justify-content-start border-top-0 px-3 py-2">
                        <div class="btn-group dropup">
                            <button type="button" class="btn btn-primary px-4" id="btn-send-email"
                                onclick="sendEmail()">Gửi</button>
                            <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                <span class="visually-hidden">Thêm tùy chọn</span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="openScheduleSendModal()"><i
                                            class="far fa-clock me-2"></i>Hẹn giờ gửi</a></li>
                            </ul>
                        </div>

                        <button class="btn btn-light btn-sm text-secondary p-2 ms-2" title="Đính kèm tệp"
                            onclick="document.getElementById('email-attachment-input').click()">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <input type="file" id="email-attachment-input" multiple style="display: none;"
                            onchange="handleFileAttachments(this)">

                        <button class="btn btn-light btn-sm text-secondary p-2" title="Chèn liên kết"
                            onclick="quill.theme.tooltip.edit()">
                            <i class="fas fa-link"></i>
                        </button>

                        <button class="btn btn-light btn-sm text-secondary p-2" title="Bản nháp" onclick="saveDraft()">
                            <i class="far fa-save"></i>
                        </button>

                        <div class="ms-auto">
                            <small class="text-muted" id="email-draft-status">Đã lưu tự động lúc 00:00</small>
                            <button class="btn btn-light btn-sm text-secondary p-2 ms-2" title="Xóa thư nháp"
                                onclick="clearDraft()">
                                <i class="far fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- JAVASCRIPT -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <!-- Quill.js JS -->
        <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

        <?!= include('js'); ?>
        <!-- MODAL: NEWS (Add/Edit) -->
        <div class="modal fade" id="newsModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="newsModalLabel">Quản lý Tin Tức</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="news-form">
                            <input type="hidden" id="news-id">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Tiêu đề bài viết <span
                                        class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="news-title" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Hình ảnh bài viết</label>
                                <input type="file" class="form-control" id="news-image-db" multiple accept="image/*"
                                    onchange="previewNewsFlagNodes()">
                                <input type="hidden" id="news-image"> <!-- To store existing URLs or uploaded URLs -->
                                <div id="news-image-preview" class="d-flex flex-wrap gap-2 mt-2"></div>
                                <small class="text-muted">Đang dùng chế độ: Upload ảnh trực tiếp lên Server.</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Nội dung</label>
                                <textarea class="form-control" id="news-content" rows="8"
                                    placeholder="Nội dung bài viết..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Trạng thái</label>
                                <select class="form-select" id="news-status">
                                    <option value="Published">Đã đăng (Published)</option>
                                    <option value="Draft">Bản nháp (Draft)</option>
                                    <option value="Hidden">Ẩn (Hidden)</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        <button type="button" class="btn btn-primary" onclick="saveNews()">
                            <i class="fas fa-save"></i> Lưu Bài Viết
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    <!-- ============================================ -->
    <!-- MODAL: BULK UPLOAD CANDIDATES -->
    <!-- ============================================ -->
    <div class="modal fade" id="bulkUploadModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-file-upload me-2"></i>Tải Hồ Sơ Hàng Loạt</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- NAV TABS -->
                    <ul class="nav nav-tabs mb-3" id="bulkUploadTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="tab-cvs-btn" data-bs-toggle="tab"
                                data-bs-target="#tab-cvs" type="button" role="tab"><i class="fas fa-file-pdf me-1"></i>
                                File CV</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tab-sheet-btn" data-bs-toggle="tab" data-bs-target="#tab-sheet"
                                type="button" role="tab"><i class="fas fa-table me-1"></i> Excel / Sheet</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="bulkUploadTabsContent">

                        <!-- TAB 1: UPLOAD CV FILES -->
                        <div class="tab-pane fade show active" id="tab-cvs" role="tabpanel">
                            <form id="bulk-upload-form">
                                <div class="mb-3">
                                    <label class="form-label">Chọn hồ sơ (PDF, Docx)</label>
                                    <input type="file" class="form-control" id="bulk-files" multiple
                                        accept=".pdf,.doc,.docx">
                                    <div class="form-text">Có thể chọn nhiều file cùng lúc (Tối đa 5 file/lần).</div>
                                </div>
                            </form>
                        </div>

                        <!-- TAB 2: IMPORT EXCEL/SHEET -->
                        <div class="tab-pane fade" id="tab-sheet" role="tabpanel">
                            <form id="sheet-import-form">
                                <div class="mb-3">
                                    <label class="form-label">Chọn phương thức nhập:</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="importType" id="import-url"
                                            value="URL" checked onchange="toggleImportInputs()">
                                        <label class="form-check-label" for="import-url">
                                            Link Google Sheet
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="importType" id="import-file"
                                            value="FILE" onchange="toggleImportInputs()">
                                        <label class="form-check-label" for="import-file">
                                            File Excel (.xlsx)
                                        </label>
                                    </div>
                                </div>

                                <div class="mb-3" id="input-url-container">
                                    <label class="form-label">Dán Link Google Sheet</label>
                                    <input type="text" class="form-control" id="sheet-url"
                                        placeholder="https://docs.google.com/spreadsheets/d/...">
                                    <div class="form-text text-warning"><i class="fas fa-exclamation-triangle"></i> Hãy
                                        chắc chắn file Google Sheet đã được chia sẻ quyền truy cập (Anyone with link
                                        hoặc share cho email sở hữu script).</div>
                                </div>

                                <div class="mb-3 d-none" id="input-file-container">
                                    <label class="form-label">Chọn file Excel hoặc CSV</label>
                                    <input type="file" class="form-control" id="sheet-file" accept=".xlsx, .csv">
                                    <div class="form-text">Khuyên dùng file <b>.csv</b> nếu import Excel bị lỗi.</div>
                                </div>
                            </form>
                        </div>

                    </div>

                    <hr>
                    <!-- COMMON SETTINGS -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nguồn ứng viên</label>
                            <select class="form-select" id="bulk-source">
                                <option value="Bulk Import">Bulk Import</option>
                                <option value="Website">Website</option>
                                <option value="LinkedIn">LinkedIn</option>
                                <option value="Referral">Referral</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Giai đoạn</label>
                            <select class="form-select" id="bulk-stage">
                                <option value="Ứng tuyển">Ứng tuyển</option>
                                <option value="New">Mới</option>
                            </select>
                        </div>
                    </div>

                    <div id="bulk-upload-progress" class="d-none">
                        <hr>
                        <h6>Tiến độ:</h6>
                        <div class="progress mb-2">
                            <div id="bulk-progress-bar"
                                class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                role="progressbar" style="width: 0%"></div>
                        </div>
                        <div id="bulk-status-text" class="small text-muted">Đang xử lý...</div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="handleImportAction()">
                        <i class="fas fa-cloud-upload-alt me-1"></i> Bắt đầu Import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: CV PREVIEW -->
    <div class="modal fade" id="cvPreviewModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered" style="height: 90vh;">
            <div class="modal-content h-100">
                <div class="modal-header bg-dark text-white py-2">
                    <h5 class="modal-title fs-6"><i class="fas fa-file-pdf me-2"></i>Xem CV Ứng Viên</h5>
                    <div class="ms-auto">
                        <a href="#" id="cv-download-btn" target="_blank" class="btn btn-sm btn-light me-2"><i
                                class="fas fa-external-link-alt"></i> Mở tab mới</a>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                </div>
                <div class="modal-body p-0" style="background: #e9ecef;">
                    <iframe id="cv-iframe" src="" style="width: 100%; height: 100%; border: none;"></iframe>
                </div>
            </div>
        </div>
    </div>
    <!-- MODAL: REQUEST EVALUATION (Legacy/Contextual) -->
    <div class="modal fade" id="requestEvaluationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Yêu cầu Đánh giá</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="req-eval-candidate-id">
                    <div class="mb-3">
                        <label class="form-label">Người đánh giá (Manager) *</label>
                        <select class="form-select" id="req-eval-manager">
                            <option value="">Chọn Manager</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="submitEvaluationRequest()">
                        <i class="fas fa-paper-plane"></i> Gửi Yêu cầu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: CREATE EVALUATION (Direct) -->
    <div class="modal fade" id="createEvaluationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-plus-circle"></i> Tạo Phiếu Đánh giá Mới</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Chọn Ứng viên *</label>
                        <select class="form-select" id="create-eval-candidate">
                            <option value="">-- Tìm kiếm ứng viên --</option>
                        </select>
                        <small class="text-muted">Chỉ hiển thị ứng viên đang ở vòng Phỏng vấn.</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Người đánh giá (Manager) *</label>
                        <div id="manager-select-container">
                            <div class="input-group mb-2 manager-row">
                                <select class="form-select manager-select">
                                    <option value="">-- Chọn Manager --</option>
                                </select>
                                <button class="btn btn-outline-danger remove-manager" type="button"
                                    style="display:none;"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="btn-add-manager"
                            onclick="addManagerInput()">
                            <i class="fas fa-user-plus"></i> Thêm người đánh giá (Tối đa 3)
                        </button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Tiêu chí Đánh giá</label>
                        <div id="criteria-container">
                            <!-- Default criteria will be added here via JS -->
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="addCriteriaInput()">
                            <i class="fas fa-plus"></i> Thêm tiêu chí khác
                        </button>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="create-eval-now">
                        <label class="form-check-label" for="create-eval-now">
                            Tôi muốn đánh giá ngay bây giờ
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="submitCreateEvaluation()">
                        <i class="fas fa-check"></i> Tạo Phiếu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: DO EVALUATION (For Manager) -->
    <div class="modal fade" id="doEvaluationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title fw-bold"><i class="fas fa-pen-nib"></i> Đánh giá Phỏng vấn</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="do-eval-id">
                    <div class="alert alert-light border shadow-sm">
                        <div class="row">
                            <div class="col-md-6">
                                <strong><i class="fas fa-user-graduate"></i> Ứng viên:</strong> <span id="do-eval-cname"
                                    class="fw-bold text-primary"></span> <br>
                                <strong><i class="fas fa-briefcase"></i> Vị trí:</strong> <span
                                    id="do-eval-position"></span>
                            </div>
                            <div class="col-md-6 border-start">
                                <strong><i class="fas fa-user-tie"></i> Người đánh giá:</strong> <span
                                    id="do-eval-mgr-name"></span> <br>
                                <strong><i class="fas fa-id-card"></i> Chức vụ:</strong> <span
                                    id="do-eval-mgr-pos"></span> (<span id="do-eval-mgr-dept"></span>)
                            </div>
                        </div>
                    </div>

                    <form id="evaluation-form">
                        <div id="dynamic-scores-container" class="row mb-3">
                            <!-- Scores will be rendered here (1-10 scale) -->
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold"><i class="fas fa-calculator text-danger"></i> Tổng
                                    điểm trung bình</label>
                                <div class="input-group">
                                    <input type="text" class="form-control fw-bold text-danger bg-light"
                                        id="eval-total-score" readonly value="0">
                                    <span class="input-group-text">/ 10</span>
                                </div>
                                <small class="text-muted" id="eval-score-label">Chưa đánh giá</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold"><i class="fas fa-hand-holding-usd text-success"></i>
                                    Mức lương đề xuất</label>
                                <input type="text" class="form-control" id="eval-proposed-salary"
                                    placeholder="VD: 15.000.000 VNĐ">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Nhận xét chi tiết <span
                                    class="text-danger">*</span></label>
                            <textarea class="form-control" id="eval-comment" rows="4"
                                placeholder="Nhập nhận xét về điểm mạnh, điểm yếu..."></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Kết quả cuối cùng <span
                                    class="text-danger">*</span></label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="eval-result" id="res-pass" value="Pass"
                                    autocomplete="off">
                                <label class="btn btn-outline-success" for="res-pass">PASS (Đạt)</label>

                                <input type="radio" class="btn-check" name="eval-result" id="res-consider"
                                    value="Consider" autocomplete="off">
                                <label class="btn btn-outline-warning" for="res-consider">CONSIDER (Cân nhắc)</label>

                                <input type="radio" class="btn-check" name="eval-result" id="res-reject" value="Reject"
                                    autocomplete="off">
                                <label class="btn btn-outline-danger" for="res-reject">REJECT (Loại)</label>
                            </div>
                        </div>

                        <div class="alert alert-info border-info mt-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="eval-signature-confirm">
                                <label class="form-check-label fw-bold" for="eval-signature-confirm">
                                    Xác nhận hoàn thành và ký điện tử phiếu đánh giá này
                                </label>
                                <div class="small text-muted">Tôi xác nhận các thông tin đánh giá trên là chính xác và
                                    chịu trách nhiệm về nội dung này.</div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-success" onclick="submitEvaluation()">
                        <i class="fas fa-check-circle"></i> Hoàn thành Đánh giá
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- MODAL: ADD/EDIT PROJECT -->
    <div class="modal fade" id="projectModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold"><i class="fas fa-project-diagram me-2"></i>Thiết lập Dự án Tuyển
                        dụng</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Project Statistics (Top Row) -->
                    <div id="proj-stats-container" class="mb-4" style="display:none;">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <div class="card border-0 shadow-sm text-center p-3 h-100"
                                    style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
                                    <div class="text-primary fw-bold small text-uppercase mb-1"
                                        style="font-size: 0.75rem;">Số lượng Ticket</div>
                                    <div class="h3 mb-0 fw-bold text-primary" id="stat-proj-tickets">0</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card border-0 shadow-sm text-center p-3 h-100"
                                    style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);">
                                    <div class="text-warning fw-bold small text-uppercase mb-1"
                                        style="font-size: 0.75rem;">Tổng SL Cần</div>
                                    <div class="h3 mb-0 fw-bold text-warning" id="stat-proj-requested">0</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card border-0 shadow-sm text-center p-3 h-100"
                                    style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);">
                                    <div class="text-success fw-bold small text-uppercase mb-1"
                                        style="font-size: 0.75rem;">Tổng Đã tuyển</div>
                                    <div class="h3 mb-0 fw-bold text-success" id="stat-proj-hired">0</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card border-0 shadow-sm text-center p-3 h-100"
                                    style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);">
                                    <div class="text-secondary fw-bold small text-uppercase mb-1"
                                        style="font-size: 0.75rem;">Tổng Chi phí</div>
                                    <div class="h4 mb-0 fw-bold text-secondary" id="stat-proj-cost">0 đ</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tickets List (Moved Up) -->
                    <div id="proj-tickets-list-container" class="mb-4" style="display:none;">
                        <label class="form-label fw-bold mb-2 text-primary"><i class="fas fa-list-ul me-2"></i>Chi tiết
                            các Ticket trong Dự án</label>
                        <div class="table-responsive border rounded-3 bg-white shadow-sm">
                            <table class="table table-sm table-hover mb-0 align-middle" style="font-size: 0.85rem;">
                                <thead style="background-color: #f8f9fa;">
                                    <tr>
                                        <th class="ps-3 py-2">Vị trí</th>
                                        <th class="text-center">Số lượng</th>
                                        <th class="text-center">Đã tuyển</th>
                                        <th>Deadline</th>
                                        <th>Chi phí</th>
                                        <th>Trạng thái</th>
                                    </tr>
                                </thead>
                                <tbody id="proj-tickets-tbody">
                                    <!-- Rows injected here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <form id="project-form">
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label class="form-label fw-bold">Tên Dự án <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="proj-name" required
                                    placeholder="VD: Tuyển dụng Khối Công nghệ Q3/2026">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Mã Dự án</label>
                                <input type="text" class="form-control bg-light" id="proj-code" readonly
                                    placeholder="Tự động tạo">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold">Ngày bắt đầu</label>
                                <input type="date" class="form-control" id="proj-start">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold">Ngày kết thúc</label>
                                <input type="date" class="form-control" id="proj-end">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold">Chỉ tiêu (Người)</label>
                                <input type="number" class="form-control" id="proj-quota" placeholder="VD: 5">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold">Ngân sách (VNĐ)</label>
                                <input type="number" class="form-control" id="proj-budget" placeholder="VD: 50.000.000">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Quản trị Dự án</label>
                            <select class="form-select" id="proj-manager">
                                <option value="Admin">Admin</option>
                            </select>
                        </div>

                        <hr>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <label class="form-label fw-bold mb-0">Quy trình Tuyển dụng (Các bước phỏng vấn)</label>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addProjectStage()">
                                <i class="fas fa-plus"></i> Thêm bước
                            </button>
                        </div>
                        <div id="project-stages-container" class="vstack gap-2 border p-3 rounded bg-light mb-4"
                            style="max-height: 200px; overflow-y: auto;">
                            <!-- Stage items will be injected here -->
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary px-4 fw-bold" onclick="saveProject()">Lưu Dự
                        án</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: CREATE RECRUITMENT TICKET -->
    <div class="modal fade" id="ticketModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title fw-bold"><i class="fas fa-ticket-alt me-2"></i>Tạo Phiếu Yêu cầu Tuyển dụng
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Ticket Statistics Area (Sync with Project Style) -->
                    <div id="ticket-stats-container" class="mb-4" style="display:none;">
                        <div class="row g-3 mb-4">
                            <div class="col-md-3">
                                <div class="card border-0 shadow-sm text-center p-3 h-100"
                                    style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
                                    <div class="text-primary fw-bold small text-uppercase mb-1"
                                        style="font-size: 0.7rem;">SỐ LƯỢNG TUYỂN</div>
                                    <div class="h4 mb-0 fw-bold text-primary" id="stat-hired-ratio">0/0</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card border-0 shadow-sm text-center p-3 h-100"
                                    style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);">
                                    <div class="text-success fw-bold small text-uppercase mb-1"
                                        style="font-size: 0.7rem;">CHI PHÍ ĐÃ CHI</div>
                                    <div class="h5 mb-0 fw-bold text-success" id="stat-total-costs">0 đ</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card border-0 shadow-sm text-center p-3 h-100"
                                    style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);">
                                    <div class="text-warning fw-bold small text-uppercase mb-1"
                                        style="font-size: 0.7rem;">DEADLINE</div>
                                    <div class="h4 mb-0 fw-bold text-warning" id="stat-days-left">0</div>
                                    <small class="text-warning-emphasis" style="font-size: 0.6rem;">ngày nữa</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card border-0 shadow-sm text-center p-3 h-100"
                                    style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);">
                                    <div class="text-purple fw-bold small text-uppercase mb-1"
                                        style="font-size: 0.7rem; color: #7b1fa2;">HIỆU QUẢ (%)</div>
                                    <div class="h4 mb-0 fw-bold" style="color: #7b1fa2;" id="stat-efficiency-perc">0%
                                    </div>
                                    <small class="text-muted" style="font-size: 0.55rem;">(Đúng hạn/Yêu cầu)</small>
                                </div>
                            </div>
                        </div>

                        <!-- Hired Candidates List Section -->
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-white py-2">
                                <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-users-check me-2"></i>Ứng viên đã
                                    nhận việc</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle mb-0" style="font-size: 0.85rem;"
                                        id="hired-candidates-table">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="ps-3 border-0">STT</th>
                                                <th class="border-0">Ứng viên</th>
                                                <th class="border-0">Ngày nhận việc</th>
                                                <th class="border-0">Tình trạng</th>
                                                <th class="pe-3 text-center border-0">Thao tác</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Recruiter Efficiency -->
                        <div class="row g-2">
                            <div class="col-md-12">
                                <small class="text-muted d-block mb-2 fw-bold"
                                    style="font-size: 0.7rem; text-transform: uppercase;">Chi tiết hiệu suất
                                    Recruiter</small>
                                <div id="stat-recruiter-performance" class="vstack gap-2"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Approval Section (New) -->
                    <div id="admin-approval-section" class="alert alert-info border-0 mb-4" style="display:none;">
                        <h6 class="fw-bold mb-3"><i class="fas fa-user-shield me-2"></i>Phê duyệt Ticket (Admin Only)
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Phân công Recruiter</label>
                                <select class="form-select form-select-sm" id="tick-admin-recruiter">
                                    <option value="">-- Chọn Recruiter --</option>
                                </select>
                            </div>
                            <div class="col-md-6 text-end d-flex align-items-end justify-content-end gap-2">
                                <button class="btn btn-sm btn-success px-3"
                                    onclick="approveTicketAction('Approved')">Duyệt</button>
                                <button class="btn btn-sm btn-danger px-3" onclick="approveTicketAction('Rejected')">Từ
                                    chối</button>
                            </div>
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label small fw-bold mb-0">Quản lý Chi phí</label>
                                    <button class="btn btn-sm btn-link text-decoration-none p-0" onclick="addCostRow()">
                                        <i class="fas fa-plus"></i> Thêm chi phí
                                    </button>
                                </div>
                                <div id="tick-costs-container" class="vstack gap-2">
                                    <!-- Dynamic cost rows -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <form id="ticket-form">
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label class="form-label fw-bold">Thuộc Dự án <span class="text-danger">*</span></label>
                                <select class="form-select" id="tick-project" required>
                                    <option value="">-- Chọn Dự án --</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Số lượng tuyển <span
                                        class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="tick-quantity" value="1" min="1">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Phòng ban <span class="text-danger">*</span></label>
                                <select class="form-select" id="tick-department" required>
                                    <option value="">-- Chọn Phòng ban --</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Vị trí cần tuyển <span
                                        class="text-danger">*</span></label>
                                <select class="form-select" id="tick-position" required>
                                    <option value="">-- Chọn Vị trí --</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label fw-bold text-primary">Ngày bắt đầu</label>
                                <input type="date" class="form-control" id="tick-start">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold text-danger">Deadline <span
                                        class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="tick-deadline">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Loại hình làm việc</label>
                                <select class="form-select" id="tick-work-type">
                                    <option value="Fulltime">Fulltime</option>
                                    <option value="Parttime">Parttime</option>
                                    <option value="Intern">Intern</option>
                                    <option value="Freelance">Freelance</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Học vấn</label>
                                <select class="form-select" id="tick-education">
                                    <option value="Không yêu cầu">Không yêu cầu</option>
                                    <option value="THPT">THPT</option>
                                    <option value="Trung cấp">Trung cấp</option>
                                    <option value="Cao đẳng">Cao đẳng</option>
                                    <option value="Đại học">Đại học</option>
                                    <option value="Sau đại học">Sau đại học</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Giới tính</label>
                                <select class="form-select" id="tick-gender">
                                    <option value="Không yêu cầu">Không yêu cầu</option>
                                    <option value="Nam">Nam</option>
                                    <option value="Nữ">Nữ</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Tuổi</label>
                                <input type="text" class="form-control" id="tick-age" placeholder="VD: 22-35">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Chuyên môn</label>
                                <input type="text" class="form-control" id="tick-major">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Kinh nghiệm</label>
                                <select class="form-select" id="tick-experience">
                                    <option value="Không yêu cầu">Không yêu cầu</option>
                                    <option value="Dưới 1 năm">Dưới 1 năm</option>
                                    <option value="1-2 năm">Từ 1 đến dưới 2 năm</option>
                                    <option value="2-3 năm">Từ 2 đến dưới 3 năm</option>
                                    <option value="3-5 năm">Từ 3 đến 5 năm</option>
                                    <option value="Trên 5 năm">Trên 5 năm</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Văn phòng làm việc</label>
                                <select class="form-select" id="tick-office">
                                    <option value="">-- Chọn văn phòng --</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Quản lý trực tiếp</label>
                                <input type="text" class="form-control" id="tick-manager">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer pb-4">
                    <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-warning px-4 fw-bold" id="btn-propose-edit"
                        onclick="saveTicket()" style="display:none;">Đề xuất chỉnh sửa</button>
                    <button type="button" class="btn btn-success px-4 fw-bold" id="btn-save-ticket"
                        onclick="saveTicket()">Gửi Yêu cầu</button>
                </div>
            </div>
        </div>
    </div>
    <div id="mention-suggestions"></div>
</body>

</html>
